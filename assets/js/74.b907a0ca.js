(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{427:function(e,a,t){"use strict";t.r(a);var s=t(48),n=Object(s.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"创建-ssl-证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建-ssl-证书"}},[e._v("#")]),e._v(" 创建 SSL 证书")]),e._v(" "),t("p",[e._v("本页将为您介绍如何为面板和 Wings 创建新的 SSL 证书")]),e._v(" "),t("tabs",[t("tab",{attrs:{name:"方法1: Certbot"}},[t("p",[e._v("首先,我们将安装 Certbot,这是一个脚本文件,它可以自动更新证书并一键创建证书。下面的命令只适合 Ubuntu，但您可以在 "),t("a",{attrs:{href:"https://certbot.eff.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Certbot 官方网站"),t("OutboundLink")],1),e._v("查看相关安装说明,我们这里包含了安装 Certbot 必要的Nginx或Apache插件的指令,这样妈妈再也不用担心我需要迁移环境了!")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt")]),e._v(" update\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" -y certbot\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Nginx 插件")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" -y python3-certbot-nginx\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Apache 插件")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" -y python3-certbot-apache\n")])])]),t("h2",{attrs:{id:"创建证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建证书"}},[e._v("#")]),e._v(" 创建证书")]),e._v(" "),t("p",[e._v("安装Certbot之后我们需要生成一个证书,最简单的方法就是安装Web服务器的Certbot插件,如果没有Web服务器的话就需要DNS验证了")]),e._v(" "),t("p",[e._v("在下面命令中,请您替换 "),t("code",[e._v("example.com")]),e._v(" 域名为您自己需要生成证书的域名,当您需要申请多个域名的证书时可以在每个域名前面添加 "),t("code",[e._v("-d")]),e._v(" 参数 ，列如 "),t("code",[e._v("-d anotherdomain.com")]),e._v("，当然您还可以考虑生成通配符证书，但本教程未涉及。")]),e._v(" "),t("h3",{attrs:{id:"http-验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#http-验证"}},[e._v("#")]),e._v(" HTTP 验证")]),e._v(" "),t("p",[e._v("HTTP 验证需要您开放服务器 80 端口来进行验证")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Nginx")]),e._v("\ncertbot certonly --nginx -d example.com\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Apache")]),e._v("\ncertbot certonly --apache -d example.com\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 如果以上两者都不起作用您可以试试这个,但是用之前请确保Web服务器已经关闭")]),e._v("\ncertbot certonly --standalone -d example.com\n")])])]),t("h3",{attrs:{id:"dns-验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dns-验证"}},[e._v("#")]),e._v(" DNS 验证")]),e._v(" "),t("p",[e._v("DNS 验证要求您去您的域名购买商那里解析相应的TXT DNS记录值以验证域名所有权，而不必公开 80 端口。在运行下面的 certbot 命令时会显示说明。")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("certbot -d example.com --manual --preferred-challenges dns certonly\n")])])]),t("h3",{attrs:{id:"自动续签"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自动续签"}},[e._v("#")]),e._v(" 自动续签")]),e._v(" "),t("p",[e._v("您可以配置证书自动续签以防止证书过期,您可以使用 "),t("code",[e._v("sudo crontab -e")]),e._v(" 打开 crontab 来添加下面的代码,该代码将在每天 23点 (晚上11点)都会检查一遍SSL证书是否过期并尝试续签")]),e._v(" "),t("p",[e._v("部署成功后将会自动重启 Nginx 并应用新的 SSL 证书,您可以将 "),t("code",[e._v("systemctl restart nginx")]),e._v(" 中的 "),t("code",[e._v("nginx")]),e._v(" 更改为 "),t("code",[e._v("apache")]),e._v(" 或 "),t("code",[e._v("wings")])]),e._v(" "),t("p",[e._v("对更高级的用户来说,我们建议使用 "),t("a",{attrs:{href:"https://acme.sh",target:"_blank",rel:"noopener noreferrer"}},[e._v("acme.sh"),t("OutboundLink")],1),e._v(" ，它提供了更多更强大的功能")]),e._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('0 23 * * * certbot renew --quiet --deploy-hook "systemctl restart nginx"\n')])])]),t("h3",{attrs:{id:"疑难解答"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#疑难解答"}},[e._v("#")]),e._v(" 疑难解答")]),e._v(" "),t("p",[e._v("如果您在尝试访问面板或 Wings 时遇到 "),t("code",[e._v("不安全连接")]),e._v(" 或 SSL/TLS 相关的错误时,有可能是您的 SSL 证书过期了,您可以通过更新 SSL 证书来解决,如果您的 80 端口正在被占用那就无法使用 "),t("code",[e._v("certbot-renew")]),e._v(" 来完成自动续签")]),e._v(" "),t("p",[e._v("如果您运行的是 Nginx,在运行 Certbot 并附带有 "),t("code",[e._v("-nginx")]),e._v(" 时出现报错您可以先停止 Nginx 服务后来续签证书，然后再启动 Nginx,如果您在为 Wings 续签证书，那你可以替换为 "),t("code",[e._v("wings")])]),e._v(" "),t("p",[e._v("停止 Nginx:")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("systemctl stop nginx\n")])])]),t("p",[e._v("续签证书:")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("certbot renew\n")])])]),t("p",[e._v("在完成续签后请使用下面的命令来重启 Nginx:")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("systemctl start nginx\n")])])]),t("p",[e._v("您可能还需要重新启动 Wings，因为并非每个服务都能够自动应用更新的证书：")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("systemctl restart wings\n")])])])]),e._v(" "),t("tab",{attrs:{name:"方法2: acme.sh (使用 Cloudflare API)"}},[t("p",[e._v("该方法适合高级用户和无法开放80端口的用户, 下面的命令适用于 Ubuntu 和 Cloudflare API,您可以查看 "),t("a",{attrs:{href:"https://github.com/Neilpang/acme.sh",target:"_blank",rel:"noopener noreferrer"}},[e._v("acme.sh 的官方网站"),t("OutboundLink")],1),e._v(" 来获取相关说明")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" https://get.acme.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sh")]),e._v("\n")])])]),t("h3",{attrs:{id:"获取-cloudflare-api-密钥"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#获取-cloudflare-api-密钥"}},[e._v("#")]),e._v(" 获取 Cloudflare API 密钥")]),e._v(" "),t("p",[e._v("安装 acme.sh 后，我们需要获取 CloudFlare API 密钥。 在 Cloudfare 的网站上，选择您的域名，然后在右侧复制您的 “区域 ID” 和 “帐户 ID”，然后单击 “获取您的 API 令牌”，单击 “创建令牌” > 选择模板 “编辑区域 DNS” > 选择 “区域资源” 的范围，然后单击 “继续以显示摘要”，复制您的令牌。")]),e._v(" "),t("h3",{attrs:{id:"申请证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#申请证书"}},[e._v("#")]),e._v(" 申请证书")]),e._v(" "),t("p",[e._v("由于配置文件基于 Certbot,所以我们需要手动创建一个文件夹")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkdir")]),e._v(" -p /etc/letsencrypt/live/example.com\n")])])]),t("p",[e._v("安装 acme 之后执行它并获取 Cloudflare 的 API 密钥,然后输入 Cloudflare 的 API 凭据来生成证书")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("CF_Token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Your_CloudFlare_API_Key"')]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("CF_Account_ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Your_CloudFlare_Account_ID"')]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("CF_Zone_ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Your_CloudFlare_Zone_ID"')]),e._v("\n\n")])])]),t("p",[e._v("然后创建证书")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("acme.sh --issue --dns dns_cf -d "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"example.com"')]),e._v(" --server letsencrypt "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--key-file /etc/letsencrypt/live/example.com/privkey.pem "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--fullchain-file /etc/letsencrypt/live/example.com/fullchain.pem\n")])])]),t("h3",{attrs:{id:"自动续签-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自动续签-2"}},[e._v("#")]),e._v(" 自动续签")]),e._v(" "),t("p",[e._v("第一次运行脚本后,它将自动添加到 crontab,您可以使用以下命令来编辑自动续订间隔")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("crontab")]),e._v(" -e\n")])])])]),e._v(" "),t("tab",{attrs:{name:"Method 3: Caddy (using Cloudflare API)"}},[t("p",[e._v("This is for advanced users, who are running Cloudflare in proxy mode or do not have access to port "),t("code",[e._v("80")]),e._v(".")]),e._v(" "),t("h3",{attrs:{id:"installing-caddy-with-cloudflare-dns-plugin"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#installing-caddy-with-cloudflare-dns-plugin"}},[e._v("#")]),e._v(" Installing Caddy with Cloudflare DNS plugin")]),e._v(" "),t("p",[e._v("Caddy does not come by default with Cloudflare DNS plugin, you need to install it yourself.")]),e._v(" "),t("p",[e._v("There are two main methods:")]),e._v(" "),t("ol",[t("li",[e._v("Using "),t("code",[e._v("xcaddy")]),e._v(" - CLI tool to build your own Caddy build")]),e._v(" "),t("li",[e._v("Downloading prebuilt binary from "),t("a",{attrs:{href:"https://caddyserver.com/download",target:"_blank",rel:"noopener noreferrer"}},[e._v("Caddy's download page"),t("OutboundLink")],1),e._v(".")]),e._v(" "),t("li",[e._v("Using Ansible to download and install Caddy with plugins. See "),t("a",{attrs:{href:"https://github.com/caddy-ansible/caddy-ansible",target:"_blank",rel:"noopener noreferrer"}},[e._v("caddy-ansible"),t("OutboundLink")],1)])]),e._v(" "),t("h4",{attrs:{id:"build-caddy-using-xcaddy-on-your-server"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#build-caddy-using-xcaddy-on-your-server"}},[e._v("#")]),e._v(" Build Caddy using "),t("code",[e._v("xcaddy")]),e._v(" on your server")]),e._v(" "),t("p",[e._v("Please refer to "),t("a",{attrs:{href:"https://caddyserver.com/docs/build#xcaddy",target:"_blank",rel:"noopener noreferrer"}},[e._v("Caddy docs on building Caddy"),t("OutboundLink")],1),e._v(".")]),e._v(" "),t("h3",{attrs:{id:"obtaining-cloudflare-api-token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#obtaining-cloudflare-api-token"}},[e._v("#")]),e._v(" Obtaining CloudFlare API Token")]),e._v(" "),t("p",[e._v('After installing acme.sh, we need to fetch a CloudFlare API key. Please make sure that a DNS record (A or CNAME record) is pointing to your target node, and set the cloud to grey (bypassing CloudFlare proxy). Then go to My Profile > API keys and on Global API Key subtab, click on "view", enter your CloudFlare password, and copy the API key to clipboard.')]),e._v(" "),t("p",[e._v('After install Caddy with Cloudflare DNS plugin, we need to fetch a Cloudflare API token. Please make sure that a DNS record (A or CNAME record) is pointing at your target node. Then go to My Profile > API Tokens and on API Tokens click "Create Token". Create API Token > API token templates, at the end of line with "Edit zone DNS", click "Use template". Under '),t("strong",[e._v("Zone Resources")]),e._v(', select your DNS zone for which you wish to create the API token, click "Continue to summary". Review the API token summary and click "Create Token". And finally copy the API token to clipboard.')]),e._v(" "),t("h3",{attrs:{id:"reconfiguring-caddy-to-use-cloudflare-dns-for-obtaining-certificates"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#reconfiguring-caddy-to-use-cloudflare-dns-for-obtaining-certificates"}},[e._v("#")]),e._v(" Reconfiguring Caddy to use Cloudflare DNS for obtaining certificates")]),e._v(" "),t("p",[e._v("Create an environment variable file (like "),t("code",[e._v(".env")]),e._v("), keep in mind that this file contains secrets and should not be accessed by public.")]),e._v(" "),t("p",[e._v("We recommend that you create the secret file in the following location: "),t("code",[e._v("/etc/caddy/.secrets.env")]),e._v(".")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("CLOUDFLARE_API_TOKEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your cloudflare api token"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),t("p",[e._v("For security reasons, we recommend setting permissions to "),t("code",[e._v("0600")]),e._v(" (only owner can read or write to the file).")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Set ownership of the `.secrets.env` file to `caddy` system user")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("chown")]),e._v(" caddy:caddy /etc/caddy/.secrets.env\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Set read-write permissions only to owner - the `caddy` system user")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("chmod")]),e._v(" 0600 /etc/caddy/.secrets.env\n")])])]),t("p",[e._v("Modify the systemd unit file, to load environment variables from file (add "),t("code",[e._v("--envfile /etc/caddy/.secrets.env")]),e._v(" flag to "),t("code",[e._v("ExecStart")]),e._v("), the default systemd unit file location is "),t("code",[e._v("/etc/systemd/system/caddy.service")]),e._v(":")]),e._v(" "),t("div",{staticClass:"language-unit extra-class"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[e._v(" ")]),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("[Unit]\nDescription=Caddy\nDocumentation=https://caddyserver.com/docs/\nAfter=network.target network-online.target\nRequires=network-online.target\n\n[Service]\nType=notify\nUser=caddy\nGroup=caddy\nExecStart=/usr/bin/caddy run --environ --envfile /etc/caddy/.secrets.env --config /etc/caddy/Caddyfile\nExecReload=/usr/bin/caddy reload --config /etc/caddy/Caddyfile\nTimeoutStopSec=5s\nLimitNOFILE=1048576\nLimitNPROC=512\nPrivateTmp=true\nProtectSystem=full\nAmbientCapabilities=CAP_NET_BIND_SERVICE\n\n[Install]\nWantedBy=multi-user.target\n")])])]),t("p",[e._v("You can add a "),t("code",[e._v("tls")]),e._v(" block to your "),t("code",[e._v("Caddyfile")]),e._v(", under the "),t("code",[e._v("<domain>")]),e._v(" block of your panel configuration, the Caddy config file location is "),t("code",[e._v("/etc/caddy/Caddyfile")]),e._v(":")]),e._v(" "),t("div",{staticClass:"language-caddyfile extra-class"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[e._v(" ")]),t("div",{staticClass:"highlighted"},[e._v(" ")]),t("div",{staticClass:"highlighted"},[e._v(" ")]),t("br")]),t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("<domain> {\n  # ...\n\n  tls {\n    dns cloudflare {env.CLOUDFLARE_API_TOKEN}\n  }\n}\n")])])])])],1)],1)}),[],!1,null,null,null);a.default=n.exports}}]);